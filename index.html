<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoPay | Cheap In-Game Currency & Box Live</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for a dark theme with green accents -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#0a0a0a',
                        'secondary-dark': '#1f2937',
                        'accent-green': '#10b981', // Emerald green for the glow
                        'accent-yellow': '#eab308', // Yellow for admin actions
                        'text-light': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Use Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a glowing effect */
        .glow-text {
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.7); /* accent-green glow */
        }
        .glow-button {
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); /* accent-green glow */
            transition: box-shadow 0.3s ease-in-out, transform 0.1s ease-in-out;
        }
        .glow-button:hover {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.9);
            transform: translateY(-2px);
        }
        /* Admin specific glow */
        .admin-glow-button {
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
            transition: box-shadow 0.3s ease-in-out, transform 0.1s ease-in-out;
        }
        .admin-glow-button:hover {
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.9);
            transform: translateY(-2px);
        }

        /* Style for the hidden modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 60;
            transition: opacity 0.3s ease;
        }
        
        /* Modal Content Animation States */
        .modal-content-hidden {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-content-visible {
            opacity: 1;
            transform: scale(1);
        }

        /* Style for the temporary alert bar */
        .alert-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(-100%);
            opacity: 0;
        }
        .alert-bar.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Animation for the flying cart particle */
        .fly-item {
            position: fixed;
            z-index: 9999;
            width: 20px;
            height: 20px;
            background-color: #10b981;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* Cart shake animation */
        @keyframes cart-shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        .cart-shake {
            animation: cart-shake 0.4s ease-in-out;
            color: #10b981; /* Turn green while shaking */
        }

        /* Prevent double-tap zoom on buttons */
        .add-to-cart-btn {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-primary-dark text-text-light font-sans min-h-screen antialiased">

    <!-- Alert Bar (Toast) -->
    <div id="alert-bar" class="alert-bar bg-accent-green text-primary-dark font-bold text-center py-3 shadow-lg">
        <span id="alert-message">Action Successful!</span>
    </div>

    <!-- Header & Navigation -->
    <header class="bg-secondary-dark/50 backdrop-blur-sm sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo Area -->
            <div class="flex items-center space-x-2 cursor-pointer" onclick="window.scrollTo(0,0)">
                <!-- Fallback placeholder image used if original URL fails -->
                <img 
                    src="https://placehold.co/150x50/10b981/ffffff?text=P" 
                    onerror="this.onerror=null;this.src='https://placehold.co/50x50/10b981/ffffff?text=P'" 
                    alt="PicoPay Logo" 
                    class="h-10 w-10 rounded-full border-2 border-accent-green"
                >
                <span class="text-2xl font-extrabold tracking-tighter hover:text-accent-green transition duration-300">PicoPay</span>
            </div>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex space-x-8 items-center">
                <a href="#products" class="nav-link text-text-light hover:text-accent-green transition duration-300">Products</a>
                <a href="#features" class="nav-link text-text-light hover:text-accent-green transition duration-300">Why Us?</a>
                <a href="#contact" class="nav-link text-text-light hover:text-accent-green transition duration-300">Contact</a>
                
                <!-- Admin Dashboard Button (Hidden by default) -->
                <button id="admin-dashboard-btn" onclick="openAdminDashboard()" class="hidden text-accent-yellow hover:text-white font-bold border border-accent-yellow/50 rounded-lg px-3 py-1 bg-accent-yellow/10 transition">
                    Admin Dashboard
                </button>

                <!-- Desktop Cart Button -->
                <button id="cart-button-desktop" class="relative p-2 text-text-light hover:text-accent-green transition duration-300" onclick="openCartModal()">
                    <!-- Shopping Cart Icon -->
                    <svg id="cart-icon-desktop" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.42a2 2 0 0 0 2 1.58h9.32a2 2 0 0 0 2-1.58L23 6H6"></path></svg>
                    <span id="cart-count-desktop" class="absolute -top-1 -right-1 bg-red-600 text-xs text-white rounded-full h-5 w-5 flex items-center justify-center scale-0 transition-transform duration-200">0</span>
                </button>

                <!-- Dynamic Auth Button Desktop -->
                <button id="auth-btn-desktop" onclick="handleAuthClick()" class="nav-link text-text-light bg-accent-green/10 px-4 py-2 rounded-lg hover:bg-accent-green/30 transition duration-300 border border-accent-green/20">
                    Sign In
                </button>
            </nav>

            <!-- Mobile Menu Area (Cart Icon + Hamburger) -->
            <div class="md:hidden flex items-center space-x-4">
                <!-- Mobile Header Cart Button -->
                <button id="cart-button-mobile" class="relative p-2 text-text-light hover:text-accent-green transition duration-300" onclick="openCartModal()">
                    <svg id="cart-icon-mobile" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.42a2 2 0 0 0 2 1.58h9.32a2 2 0 0 0 2-1.58L23 6H6"></path></svg>
                    <span id="cart-count-mobile-header" class="absolute -top-1 -right-1 bg-red-600 text-xs text-white rounded-full h-5 w-5 flex items-center justify-center scale-0 transition-transform duration-200">0</span>
                </button>

                <!-- Mobile Menu Button -->
                <button id="menu-button" class="p-2 text-text-light hover:text-accent-green transition duration-300" onclick="toggleMobileMenu()">
                    <!-- Hamburger Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="hidden md:hidden bg-secondary-dark/95 border-t border-accent-green/20 absolute w-full left-0 top-full z-[40]">
            <nav class="flex flex-col space-y-2 p-4 shadow-xl">
                <!-- Mobile Admin Link (Hidden by default) -->
                <button id="admin-dashboard-btn-mobile" onclick="openAdminDashboard(); toggleMobileMenu();" class="hidden w-full text-left py-2 px-3 text-accent-yellow bg-accent-yellow/10 rounded-md hover:bg-accent-yellow/20 font-bold transition">
                    Admin Dashboard
                </button>
                
                <a href="#products" class="block py-2 px-3 hover:bg-accent-green/20 rounded-md transition duration-300 text-text-light" onclick="toggleMobileMenu()">Products</a>
                <a href="#features" class="block py-2 px-3 hover:bg-accent-green/20 rounded-md transition duration-300 text-text-light" onclick="toggleMobileMenu()">Why Us?</a>
                <a href="#contact" class="block py-2 px-3 hover:bg-accent-green/20 rounded-md transition duration-300 text-text-light" onclick="toggleMobileMenu()">Contact</a>
                
                <!-- Mobile Auth Button -->
                <button id="auth-btn-mobile" onclick="handleAuthClick(); toggleMobileMenu();" class="w-full text-left py-2 px-3 bg-accent-green/10 rounded-md hover:bg-accent-green/30 transition duration-300 text-text-light border border-accent-green/20">
                    Sign In
                </button>
                
                <!-- Mobile Cart Button (Menu Item) -->
                <button class="w-full py-2 px-3 text-left relative hover:bg-accent-green/20 rounded-md transition duration-300 flex items-center justify-start space-x-2 text-text-light" onclick="openCartModal(); toggleMobileMenu();">
                    <!-- Shopping Cart Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.42a2 2 0 0 0 2 1.58h9.32a2 2 0 0 0 2-1.58L23 6H6"></path></svg>
                    <span>Cart</span>
                    <span id="cart-count-mobile" class="ml-auto bg-red-600 text-xs text-white rounded-full h-5 w-5 flex items-center justify-center scale-0 transition-transform duration-200">0</span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        
        <!-- Hero Section -->
        <section class="text-center py-12 md:py-24">
            <h1 class="text-4xl sm:text-6xl md:text-7xl font-extrabold mb-4 leading-tight">
                Unlock <span class="text-accent-green glow-text">Peak Gaming</span> Power
            </h1>
            <p class="text-lg sm:text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                The fastest and cheapest source for in-game currency, premium items, and Box Live subscriptions. Get instant delivery, guaranteed security.
            </p>
            <div class="space-y-4 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row justify-center mb-12">
                <button class="glow-button bg-accent-green text-primary-dark font-semibold px-8 py-3 rounded-xl shadow-lg hover:bg-green-500 transition duration-300" onclick="scrollToElement('products')">
                    Browse Deals Now
                </button>
                <a href="#features" class="glow-button bg-secondary-dark text-text-light border border-accent-green/50 font-semibold px-8 py-3 rounded-xl shadow-lg hover:bg-secondary-dark/80 transition duration-300 flex items-center justify-center">
                    Learn More
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                </a>
            </div>
        </section>

        <!-- Products Section (DYNAMICALLY RENDERED) -->
        <section id="products" class="py-12 md:py-20 scroll-mt-24">
            <h2 class="text-3xl sm:text-4xl font-bold mb-10 text-center border-b border-accent-green/50 pb-4">Our Top Deals</h2>
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- JavaScript will inject product cards here -->
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="py-12 md:py-20 scroll-mt-24">
            <h2 class="text-3xl sm:text-4xl font-bold mb-10 text-center border-b border-accent-green/50 pb-4">Why Choose PicoPay?</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                <!-- Feature 1: Speed -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg border border-accent-green/10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mx-auto mb-3"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                    <h3 class="font-semibold text-xl mb-2 text-text-light">Instant Delivery</h3>
                    <p class="text-gray-400 text-sm">Codes and currency delivered in seconds, not hours.</p>
                </div>
                <!-- Feature 2: Price -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg border border-accent-green/10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mx-auto mb-3"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    <h3 class="font-semibold text-xl mb-2 text-text-light">Unbeatable Prices</h3>
                    <p class="text-gray-400 text-sm">We guarantee the lowest market rates on all items.</p>
                </div>
                <!-- Feature 3: Security -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg border border-accent-green/10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mx-auto mb-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <h3 class="font-semibold text-xl mb-2 text-text-light">100% Secure</h3>
                    <p class="text-gray-400 text-sm">All transactions are secured with industry-leading encryption.</p>
                </div>
                <!-- Feature 4: Support -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg border border-accent-green/10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mx-auto mb-3"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                    <h3 class="font-semibold text-xl mb-2 text-text-light">24/7 Support</h3>
                    <p class="text-gray-400 text-sm">Our expert team is always ready to assist you via chat or email.</p>
                </div>
            </div>
        </section>

        <!-- Call to Action / Contact Section -->
        <section id="contact" class="py-12 md:py-20 text-center bg-secondary-dark rounded-xl shadow-2xl mt-12 border border-accent-green/10">
            <h2 class="text-3xl font-bold mb-4 text-accent-green">Ready to Level Up?</h2>
            <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">
                Join thousands of satisfied gamers who trust PicoPay for their in-game needs. Click below to start saving!
            </p>
            <button class="glow-button bg-accent-green text-primary-dark font-semibold px-10 py-4 rounded-xl shadow-lg hover:bg-green-500 transition duration-300 text-xl" onclick="scrollToElement('products')">
                Start Shopping
            </button>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-secondary-dark/50 mt-16 border-t border-accent-green/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-gray-400 text-sm">
            <p>&copy; 2025 PicoPay. All rights reserved.</p>
            <div class="mt-2 space-x-4">
                <button class="hover:text-accent-green transition duration-300 underline" onclick="openPrivacyModal()">Privacy Policy</button>
                <button onclick="openTermsModal()" class="hover:text-accent-green transition duration-300 underline">Terms of Service</button>
            </div>
        </div>
    </footer>

    <!-- Global Message Box (Custom Modal) -->
    <div id="message-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[110]">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border border-accent-green/50 transform transition-all duration-300 modal-content-hidden" id="message-modal-content">
            <h3 class="text-xl font-bold mb-3 text-accent-green">Notification</h3>
            <p id="modal-message" class="text-text-light mb-6"></p>
            <div class="flex justify-end">
                <button class="bg-accent-green text-primary-dark font-semibold px-4 py-2 rounded-lg hover:bg-green-500 transition duration-300" onclick="closeMessageModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal (Sign In / Register) -->
    <div id="auth-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[100] p-4">
        <div class="bg-secondary-dark p-8 rounded-xl shadow-2xl max-w-md w-full border border-accent-green/50 transform transition-all duration-300 modal-content-hidden" id="auth-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="auth-title" class="text-2xl font-bold text-accent-green">Sign In</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closeAuthModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                    <input type="email" id="auth-email" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-green focus:outline-none focus:ring-1 focus:ring-accent-green" placeholder="you@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="auth-password" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-green focus:outline-none focus:ring-1 focus:ring-accent-green" placeholder="••••••••">
                </div>
                
                <button id="auth-submit-btn" class="w-full glow-button bg-accent-green text-primary-dark font-semibold py-3 rounded-lg shadow-lg hover:bg-green-500 transition duration-300" onclick="handleAuthSubmit()">
                    Sign In
                </button>
                
                <p class="text-center text-sm text-gray-400 mt-4">
                    <span id="auth-toggle-text">Don't have an account?</span>
                    <button id="auth-toggle-btn" class="text-accent-green hover:underline ml-1" onclick="toggleAuthMode()">Register</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Guest Checkout Modal -->
    <div id="guest-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[105] p-4">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border border-accent-green/50 transform transition-all duration-300 modal-content-hidden" id="guest-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-accent-green">Guest Checkout</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closeGuestModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <p class="text-gray-400 text-sm mb-4">Enter your Gamertag to receive your items instantly without an account.</p>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-1">Gamertag / Username</label>
                <input type="text" id="guest-gamertag" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-green focus:outline-none focus:ring-1 focus:ring-accent-green" placeholder="e.g. ProGamer123">
                <p id="guest-error" class="text-red-500 text-xs mt-1 hidden">Gamertag is required.</p>
            </div>

            <button id="guest-checkout-btn" class="w-full glow-button bg-accent-green text-primary-dark font-semibold py-3 rounded-lg shadow-lg hover:bg-green-500 transition duration-300" onclick="handleGuestCheckout()">
                Continue to Payment
            </button>

            <div class="mt-4 text-center border-t border-accent-green/20 pt-4">
                <p class="text-sm text-gray-400 mb-2">Want to save your order history?</p>
                <button class="text-accent-green hover:underline text-sm font-semibold" onclick="switchToAuthFromGuest()">Sign In / Register</button>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD MODAL (NEW CENTRAL MANAGEMENT) -->
    <div id="admin-dashboard-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[110] p-4">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-4xl w-full h-[80vh] flex flex-col border border-accent-yellow/50 transform transition-all duration-300 modal-content-hidden" id="admin-dashboard-modal-content">
            <div class="flex justify-between items-center mb-6 border-b border-accent-yellow/30 pb-3">
                <h3 class="text-2xl font-bold text-accent-yellow">Product Dashboard</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closeAdminDashboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <!-- Product List -->
            <div class="overflow-y-auto flex-grow">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-primary-dark text-accent-yellow text-sm uppercase">
                        <tr>
                            <th class="p-3 rounded-tl-lg">ID</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Price</th>
                            <th class="p-3 rounded-tr-lg text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-product-list" class="divide-y divide-gray-700 text-sm">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin Product Edit Modal -->
    <div id="admin-product-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[120] p-4">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-md w-full border border-accent-yellow/50 transform transition-all duration-300 modal-content-hidden" id="admin-product-modal-content">
            <div class="flex justify-between items-center mb-6 border-b border-accent-yellow/30 pb-3">
                <h3 class="text-xl font-bold text-accent-yellow">Edit Product</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closeAdminProductModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <input type="hidden" id="admin-edit-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Product Name</label>
                    <input type="text" id="admin-edit-name" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-yellow focus:outline-none focus:ring-1 focus:ring-accent-yellow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Description</label>
                    <textarea id="admin-edit-desc" rows="3" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-yellow focus:outline-none focus:ring-1 focus:ring-accent-yellow"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Price ($)</label>
                        <input type="number" step="0.01" id="admin-edit-price" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-yellow focus:outline-none focus:ring-1 focus:ring-accent-yellow">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Original Price ($)</label>
                        <input type="number" step="0.01" id="admin-edit-original-price" class="w-full bg-primary-dark border border-gray-700 rounded-lg px-4 py-2 text-text-light focus:border-accent-yellow focus:outline-none focus:ring-1 focus:ring-accent-yellow">
                    </div>
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button class="text-gray-400 hover:text-white px-4 py-2" onclick="closeAdminProductModal()">Cancel</button>
                    <button class="admin-glow-button bg-accent-yellow text-primary-dark font-bold px-6 py-2 rounded-lg" onclick="saveProductChanges()">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shopping Cart Modal -->
    <div id="cart-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[100]">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-lg w-full border border-accent-green/50 transform transition-all duration-300 modal-content-hidden mx-4" id="cart-modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-accent-green/50 pb-2">
                <h3 class="text-2xl font-bold text-accent-green">Your Cart</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closeCartModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div id="cart-items-container" class="space-y-4 max-h-80 overflow-y-auto pr-2 mb-4 scrollbar-thin scrollbar-thumb-accent-green scrollbar-track-secondary-dark">
                <!-- Cart items will be injected here -->
                <p id="empty-cart-message" class="text-gray-500 italic text-center py-4">Your cart is empty. Time to shop!</p>
            </div>

            <div id="cart-summary" class="border-t border-accent-green/50 pt-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold">Total:</span>
                    <span id="cart-total" class="text-3xl font-extrabold text-accent-green">$0.00</span>
                </div>
                <button id="checkout-button" class="w-full glow-button bg-accent-green text-primary-dark font-semibold py-3 rounded-lg shadow-lg hover:bg-green-500 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" onclick="checkout()">
                    Proceed to Checkout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Terms of Service Modal -->
    <div id="terms-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[100] p-4">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-3xl w-full h-full max-h-[80vh] flex flex-col border border-accent-green/50 transform transition-all duration-300 modal-content-hidden" id="terms-modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-accent-green/50 pb-2 flex-shrink-0">
                <h3 class="text-2xl font-bold text-accent-green">PicoPay - Terms of Service</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closeTermsModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="overflow-y-auto pr-4 text-sm text-gray-300 flex-grow">
                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">1. Acceptance of Terms</h4>
                <p class="mb-4">By accessing or using the PicoPay service ("Service"), you agree to be bound by these Terms of Service.</p>

                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">2. Service Description</h4>
                <p class="mb-4">PicoPay provides a platform for purchasing virtual in-game currency, digital goods, and gaming subscriptions. All purchases are final.</p>
                
                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">3. User Obligations</h4>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    <li>You must be at least 13 years old to use the Service.</li>
                    <li>You agree not to use the Service for any illegal or unauthorized purpose.</li>
                </ul>

                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">4. Digital Goods & Delivery</h4>
                <p class="mb-4">All digital goods are delivered electronically instantly upon successful payment verification.</p>

                <p class="pt-4 text-center text-gray-500 italic">Last Updated: November 24, 2025</p>
            </div>
            <div class="mt-4 pt-2 border-t border-accent-green/20 text-right">
                <button class="bg-accent-green text-primary-dark font-semibold px-4 py-2 rounded-lg hover:bg-green-500 transition duration-300" onclick="closeTermsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[100] p-4">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-3xl w-full h-full max-h-[80vh] flex flex-col border border-accent-green/50 transform transition-all duration-300 modal-content-hidden" id="privacy-modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-accent-green/50 pb-2 flex-shrink-0">
                <h3 class="text-2xl font-bold text-accent-green">PicoPay - Privacy Policy</h3>
                <button class="text-gray-400 hover:text-red-500" onclick="closePrivacyModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="overflow-y-auto pr-4 text-sm text-gray-300 flex-grow">
                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">1. Information Collection</h4>
                <p class="mb-4">We collect information you provide directly to us, such as when you create an account.</p>

                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">2. Use of Information</h4>
                <p class="mb-4">We use the information we collect to provide, maintain, and improve our services.</p>
                
                <h4 class="text-lg font-bold text-text-light mt-4 mb-2">3. Data Security</h4>
                <p class="mb-4">We implement appropriate security measures to protect your personal information.</p>

                <p class="pt-4 text-center text-gray-500 italic">Last Updated: November 24, 2025</p>
            </div>

            <div class="flex justify-end pt-4 flex-shrink-0 border-t border-accent-green/50 mt-4">
                <button class="bg-accent-green text-primary-dark font-semibold px-4 py-2 rounded-lg hover:bg-green-500 transition duration-300" onclick="closePrivacyModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // --- State Management ---
        let cart = [];
        let isLoggedIn = false;
        let isAdmin = false; // ADMIN FLAG
        let authMode = 'login'; // 'login' or 'register'

        // --- Product Data (Dynamic for Editing) ---
        // Initializing with default products
        let products = [
            { 
                id: 'P001', 
                name: '10,000 Gold Coins', 
                price: 19.99, 
                originalPrice: 29.99, 
                desc: 'The essential currency for every serious player. Instant deposit after purchase.' 
            },
            { 
                id: 'P002', 
                name: 'Box Live (12 Months)', 
                price: 49.99, 
                originalPrice: 59.99, 
                desc: 'Access online multiplayer and free games for a full year. Key emailed instantly.' 
            },
            { 
                id: 'P003', 
                name: 'Epic Loot Crate', 
                price: 9.99, 
                originalPrice: 14.99, 
                desc: 'Guaranteed rare item drop. Limited stock available this week!' 
            }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();
        });

        // --- Product Rendering Logic ---
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = ''; // Clear existing content

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = "product-card bg-secondary-dark p-6 rounded-xl shadow-xl hover:shadow-accent-green/20 transition duration-300 border border-secondary-dark hover:border-accent-green/50 flex flex-col h-full relative";
                
                // Admin Edit Button Overlay on Card
                let adminControls = '';
                if (isAdmin) {
                    // Using onclick with ID directly (ensure IDs are simple strings)
                    adminControls = `
                        <button onclick="openAdminProductModal('${product.id}')" class="absolute top-4 right-4 bg-accent-yellow text-primary-dark font-bold text-xs px-2 py-1 rounded hover:bg-yellow-400 transition z-10 shadow-lg">
                            EDIT
                        </button>
                    `;
                }

                card.innerHTML = `
                    ${adminControls}
                    <h3 class="text-xl font-bold mb-2 text-accent-green">${product.name}</h3>
                    <p class="text-gray-400 mb-4 flex-grow">${product.desc}</p>
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-3xl font-extrabold text-text-light">$${product.price.toFixed(2)}</span>
                        ${product.originalPrice ? `<span class="text-sm line-through text-gray-500">$${product.originalPrice.toFixed(2)}</span>` : ''}
                    </div>
                    <button class="add-to-cart-btn w-full glow-button bg-accent-green text-primary-dark font-semibold py-2 rounded-lg" onclick="addToCart(this)" data-id="${product.id}" data-price="${product.price}" data-name="${product.name}">
                        Add to Cart
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        // --- Utility Functions ---
        function formatPrice(price) {
            return '$' + parseFloat(price).toFixed(2);
        }

        // --- Alert / Toast System ---
        function showAlert(message) {
            const bar = document.getElementById('alert-bar');
            const msg = document.getElementById('alert-message');
            msg.textContent = message;
            bar.classList.add('show');
            setTimeout(() => {
                bar.classList.remove('show');
            }, 3000);
        }

        // --- Generic Modal Logic ---
        function openModal(modalId, contentId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('modal-content-hidden');
                content.classList.add('modal-content-visible');
            }, 10);
        }

        function closeModal(modalId, contentId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            
            content.classList.remove('modal-content-visible');
            content.classList.add('modal-content-hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Modal Specific Wrappers
        function openMessageModal(message) {
            document.getElementById('modal-message').textContent = message;
            openModal('message-modal', 'message-modal-content');
        }
        function closeMessageModal() { closeModal('message-modal', 'message-modal-content'); }

        function openTermsModal() { openModal('terms-modal', 'terms-modal-content'); }
        function closeTermsModal() { closeModal('terms-modal', 'terms-modal-content'); }

        function openPrivacyModal() { openModal('privacy-modal', 'privacy-modal-content'); }
        function closePrivacyModal() { closeModal('privacy-modal', 'privacy-modal-content'); }

        function openCartModal() { 
            renderCart();
            openModal('cart-modal', 'cart-modal-content'); 
        }
        function closeCartModal() { closeModal('cart-modal', 'cart-modal-content'); }

        // --- Admin Dashboard Logic (NEW) ---
        function openAdminDashboard() {
            renderAdminProductList();
            openModal('admin-dashboard-modal', 'admin-dashboard-modal-content');
        }

        function closeAdminDashboard() {
            closeModal('admin-dashboard-modal', 'admin-dashboard-modal-content');
        }

        function renderAdminProductList() {
            const tbody = document.getElementById('admin-product-list');
            tbody.innerHTML = '';

            products.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-primary-dark/30';
                tr.innerHTML = `
                    <td class="p-3 text-gray-400 font-mono text-xs">${p.id}</td>
                    <td class="p-3 font-medium text-text-light">${p.name}</td>
                    <td class="p-3 text-accent-green">$${p.price.toFixed(2)}</td>
                    <td class="p-3 text-right">
                        <button onclick="openAdminProductModal('${p.id}')" class="text-accent-yellow hover:text-white text-sm font-bold underline">
                            Edit
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Admin Product Editing Logic ---
        function openAdminProductModal(productId) {
            // If opening from dashboard, we might want to close dashboard temporarily or keep it open behind.
            // For simplicity, we open on top (z-index 120 vs 110).
            
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Populate Form
            document.getElementById('admin-edit-id').value = product.id;
            document.getElementById('admin-edit-name').value = product.name;
            document.getElementById('admin-edit-desc').value = product.desc;
            document.getElementById('admin-edit-price').value = product.price;
            document.getElementById('admin-edit-original-price').value = product.originalPrice || '';

            openModal('admin-product-modal', 'admin-product-modal-content');
        }

        function closeAdminProductModal() {
            closeModal('admin-product-modal', 'admin-product-modal-content');
        }

        function saveProductChanges() {
            const id = document.getElementById('admin-edit-id').value;
            const name = document.getElementById('admin-edit-name').value;
            const desc = document.getElementById('admin-edit-desc').value;
            
            // Critical: Ensure these are numbers
            const price = parseFloat(document.getElementById('admin-edit-price').value);
            const originalPriceInput = document.getElementById('admin-edit-original-price').value;
            const originalPrice = originalPriceInput ? parseFloat(originalPriceInput) : null;

            // Find and Update
            const index = products.findIndex(p => p.id === id);
            if (index !== -1) {
                // Update product data
                products[index] = { 
                    ...products[index], 
                    name, 
                    desc, 
                    price: isNaN(price) ? 0 : price, 
                    originalPrice: isNaN(originalPrice) ? null : originalPrice 
                };

                // Refresh UI
                renderProducts(); // Updates the main store grid
                renderAdminProductList(); // Updates the dashboard table if open
                closeAdminProductModal();
                showAlert("Product updated successfully!");
                
                // Update cart items if they exist to reflect new price/name
                cart = cart.map(item => {
                    if (item.id === id) {
                        return { ...item, name, price: products[index].price };
                    }
                    return item;
                });
                updateCartCounts(); 
            }
        }

        // --- Guest Checkout Logic ---
        function openGuestModal() {
            document.getElementById('guest-gamertag').value = '';
            document.getElementById('guest-error').classList.add('hidden');
            openModal('guest-modal', 'guest-modal-content');
        }
        function closeGuestModal() { closeModal('guest-modal', 'guest-modal-content'); }

        function handleGuestCheckout() {
            const gamertagInput = document.getElementById('guest-gamertag');
            const errorMsg = document.getElementById('guest-error');
            const gamertag = gamertagInput.value.trim();

            if (!gamertag) {
                errorMsg.classList.remove('hidden');
                gamertagInput.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                gamertagInput.classList.remove('focus:ring-accent-green', 'focus:border-accent-green');
                return;
            }

            errorMsg.classList.add('hidden');
            gamertagInput.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
            gamertagInput.classList.add('focus:ring-accent-green', 'focus:border-accent-green');

            const btn = document.getElementById('guest-checkout-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Verifying...';
            btn.disabled = true;

            setTimeout(() => {
                closeGuestModal();
                btn.textContent = originalText;
                btn.disabled = false;
                finalizeTransaction(gamertag);
            }, 800);
        }

        function switchToAuthFromGuest() {
            closeGuestModal();
            setTimeout(() => {
                openModal('auth-modal', 'auth-modal-content');
            }, 300);
        }

        // --- Auth Logic ---
        function handleAuthClick() {
            if (isLoggedIn) {
                // Sign Out
                isLoggedIn = false;
                isAdmin = false;
                
                // Hide Admin UI
                document.getElementById('admin-dashboard-btn').classList.add('hidden');
                document.getElementById('admin-dashboard-btn-mobile').classList.add('hidden');
                
                renderProducts(); // Remove admin buttons from cards
                updateAuthUI();
                showAlert("Signed out successfully.");
            } else {
                openModal('auth-modal', 'auth-modal-content');
            }
        }

        function closeAuthModal() {
            closeModal('auth-modal', 'auth-modal-content');
            document.getElementById('auth-email').value = '';
            document.getElementById('auth-password').value = '';
        }

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-submit-btn');
            const toggleText = document.getElementById('auth-toggle-text');
            const toggleBtn = document.getElementById('auth-toggle-btn');

            if (authMode === 'register') {
                title.textContent = 'Create Account';
                btn.textContent = 'Register';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
            } else {
                title.textContent = 'Sign In';
                btn.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Register';
            }
        }

        function handleAuthSubmit() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                const content = document.getElementById('auth-modal-content');
                content.classList.add('animate-pulse');
                setTimeout(() => content.classList.remove('animate-pulse'), 500);
                return;
            }

            // ADMIN CHECK
            if (email === 'Jakeciocca1@gmail.com' && password === 'PicoAdmin2025') {
                isAdmin = true;
                isLoggedIn = true;
                closeAuthModal();
                updateAuthUI();
                
                // Show Admin UI
                document.getElementById('admin-dashboard-btn').classList.remove('hidden');
                document.getElementById('admin-dashboard-btn-mobile').classList.remove('hidden');
                
                renderProducts(); // Re-render to show edit buttons on cards
                showAlert("Admin Mode Activated!");
                return;
            }

            // Normal User Flow
            setTimeout(() => {
                isLoggedIn = true;
                closeAuthModal();
                updateAuthUI();
                showAlert(authMode === 'login' ? "Welcome back!" : "Account created successfully!");
            }, 500);
        }

        function updateAuthUI() {
            const desktopBtn = document.getElementById('auth-btn-desktop');
            const mobileBtn = document.getElementById('auth-btn-mobile');
            
            if (isLoggedIn) {
                desktopBtn.textContent = isAdmin ? 'Admin Logout' : 'Sign Out';
                desktopBtn.classList.add('bg-red-500/10', 'hover:bg-red-500/30');
                desktopBtn.classList.remove('bg-accent-green/10', 'hover:bg-accent-green/30');
                
                mobileBtn.textContent = isAdmin ? 'Admin Logout' : 'Sign Out';
            } else {
                desktopBtn.textContent = 'Sign In';
                desktopBtn.classList.remove('bg-red-500/10', 'hover:bg-red-500/30');
                desktopBtn.classList.add('bg-accent-green/10', 'hover:bg-accent-green/30');
                
                mobileBtn.textContent = 'Sign In';
            }
        }

        // --- Cart Logic ---
        function addToCart(btn) {
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            const price = parseFloat(btn.getAttribute('data-price'));

            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ id, name, price, quantity: 1 });
            }

            animateFlyToCart(btn);
            updateCartCounts();
            // Note: Alert removed to show particle
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            renderCart();
            updateCartCounts();
        }

        function updateQuantity(id, change) {
            const item = cart.find(item => item.id === id);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(id);
                } else {
                    renderCart();
                    updateCartCounts();
                }
            }
        }

        function updateCartCounts() {
            const count = cart.reduce((total, item) => total + item.quantity, 0);
            const desktopBadge = document.getElementById('cart-count-desktop');
            const mobileHeaderBadge = document.getElementById('cart-count-mobile-header');
            const mobileMenuBadge = document.getElementById('cart-count-mobile');

            [desktopBadge, mobileHeaderBadge, mobileMenuBadge].forEach(el => {
                el.textContent = count;
                if (count > 0) {
                    el.classList.remove('scale-0');
                } else {
                    el.classList.add('scale-0');
                }
            });
        }

        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const totalEl = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-button');

            container.innerHTML = '';
            
            if (cart.length === 0) {
                container.innerHTML = '<p id="empty-cart-message" class="text-gray-500 italic text-center py-4">Your cart is empty. Time to shop!</p>';
                totalEl.textContent = '$0.00';
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            checkoutBtn.disabled = false;
            checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            let total = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-primary-dark/50 p-3 rounded-lg border border-gray-700';
                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <h4 class="font-bold text-sm text-text-light">${item.name}</h4>
                        <p class="text-xs text-gray-400">${formatPrice(item.price)} each</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center bg-secondary-dark rounded-lg">
                            <button onclick="updateQuantity('${item.id}', -1)" class="px-2 py-1 text-gray-400 hover:text-white">-</button>
                            <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity('${item.id}', 1)" class="px-2 py-1 text-gray-400 hover:text-white">+</button>
                        </div>
                        <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            totalEl.textContent = formatPrice(total);
        }

        function checkout() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total <= 0) {
                showAlert("Your cart is empty.");
                return;
            }

            closeCartModal();

            if (isLoggedIn) {
                finalizeTransaction();
            } else {
                setTimeout(() => {
                    openGuestModal();
                }, 300);
            }
        }

        function finalizeTransaction(gamertag = null) {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let message = "Redirecting to PayPal...";
            if (gamertag) message = `Processing for guest: ${gamertag}. Redirecting...`;
            showAlert(message);

            setTimeout(() => {
                const paypalUrl = `https://www.paypal.com/paypalme/Peanzyi/${total.toFixed(2)}`;
                window.open(paypalUrl, '_blank');
                cart = []; 
                updateCartCounts();
                let successMsg = `Redirected to PayPal for payment of $${total.toFixed(2)}!`;
                if(gamertag) successMsg += ` (Gamertag: ${gamertag})`;
                openMessageModal(successMsg);
            }, 1000);
        }

        // --- Animations ---
        function animateFlyToCart(startElement) {
            const mobileBtn = document.getElementById('cart-button-mobile');
            const desktopBtn = document.getElementById('cart-button-desktop');
            
            let targetBtn = null;
            if (desktopBtn && desktopBtn.getBoundingClientRect().width > 0) {
                targetBtn = desktopBtn;
            } else if (mobileBtn && mobileBtn.getBoundingClientRect().width > 0) {
                targetBtn = mobileBtn;
            }

            if (!targetBtn) return;
            const targetIcon = targetBtn.querySelector('svg');
            const fly = document.createElement('div');
            fly.className = 'fly-item';
            document.body.appendChild(fly);

            const startRect = startElement.getBoundingClientRect();
            const targetRect = targetBtn.getBoundingClientRect();

            const startX = startRect.left + (startRect.width / 2);
            const startY = startRect.top + (startRect.height / 2);
            const targetX = targetRect.left + (targetRect.width / 2);
            const targetY = targetRect.top + (targetRect.height / 2);

            fly.style.left = (startX - 10) + 'px';
            fly.style.top = (startY - 10) + 'px';

            void fly.offsetHeight;
            const deltaX = targetX - startX;
            const deltaY = targetY - startY;

            fly.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.2)`;
            fly.style.opacity = '0.5';

            setTimeout(() => {
                fly.remove();
                if (targetIcon) {
                    targetIcon.classList.add('cart-shake');
                    setTimeout(() => targetIcon.classList.remove('cart-shake'), 400);
                }
            }, 800);
        }

        // --- Navigation Logic ---
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        }

        function scrollToElement(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal-backdrop')) {
                const modalId = event.target.id;
                const contentId = modalId + '-content';
                closeModal(modalId, contentId);
            }
        }
    </script>
</body>
</html>
